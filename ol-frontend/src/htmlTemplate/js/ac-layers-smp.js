
proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
proj4.defs("EPSG:27561","+proj=lcc +lat_1=49.50000000000001 +lat_0=49.50000000000001 +lon_0=0 +k_0=0.999877341 +x_0=600000 +y_0=200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");
proj4.defs("EPSG:27572","+proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=0 +k_0=0.99987742 +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515 +towgs84=-168,-60,320,0,0,0,0 +pm=paris +units=m +no_defs");

var L93 = ol.proj.get('EPSG:2154');
var L1N = ol.proj.get('EPSG:27561');
var L2E = ol.proj.get('EPSG:27572');

var smpTmsSvcHost = '127.0.0.1'

//Dark red stroke, no fill
var smpClipStyle = new ol.style.Style({
    stroke: new ol.style.Stroke({
      color:  [200, 0, 0, 128],
      width:3
    }),
    fill: new ol.style.Fill({
      color: [0, 0, 0, 0]
    })
});

/**
 * Definition of the most up-to-date Imagery SMP layer tp display
 ******************************************************************/

var resSMPLatest = [6553.6, 3276.8, 1638.4,819.2,409.6,204.8,102.4,51.2,25.6, 12.8, 6.4, 3.2, 1.6, 0.8, 0.4, 0.2];
var extentSMPLatest = [585000.0500, 6777999.9500, 1404200.0500, 7597199.9500];
var clipSmpLatest = new ol.geom.Polygon(
	[ [ [ 590000.0, 6889000.0 ], [ 593000.0, 6889000.0 ], [ 593000.0, 6888000.0 ], [ 595000.0, 6888000.0 ], [ 595000.0, 6889000.0 ], [ 597000.0, 6889000.0 ], [ 597000.0, 6890000.0 ], [ 598000.0, 6890000.0 ], [ 598000.0, 6891000.0 ], [ 599000.0, 6891000.0 ], [ 599000.0, 6893000.0 ], [ 600000.0, 6893000.0 ], [ 600000.0, 6894000.0 ], [ 601000.0, 6894000.0 ], [ 601000.0, 6898000.0 ], [ 602000.0, 6898000.0 ], [ 602000.0, 6901382.1341956342 ], [ 602872.51414713007, 6902263.2174616 ], [ 602874.2118027485, 6903000.0 ], [ 603000.0, 6903000.0 ], [ 603000.0, 6904000.0 ], [ 604000.0, 6904000.0 ], [ 604000.0, 6905000.0 ], [ 605000.0, 6905000.0 ], [ 605000.0, 6906000.0 ], [ 608000.0, 6906000.0 ], [ 608000.0, 6905000.0 ], [ 609000.0, 6905000.0 ], [ 609000.0, 6904000.0 ], [ 610000.0, 6904000.0 ], [ 610000.0, 6902000.0 ], [ 609000.0, 6902000.0 ], [ 609000.0, 6901000.0 ], [ 610000.0, 6901000.0 ], [ 610000.0, 6900000.0 ], [ 616000.0, 6900000.0 ], [ 616000.0, 6899000.0 ], [ 619000.0, 6899000.0 ], [ 619000.0, 6898000.0 ], [ 620000.0, 6898000.0 ], [ 620000.0, 6899000.0 ], [ 624000.0, 6899000.0 ], [ 624000.0, 6900000.0 ], [ 628000.0, 6900000.0 ], [ 628000.0, 6901000.0 ], [ 630000.0, 6901000.0 ], [ 630000.0, 6902000.0 ], [ 631000.0, 6902000.0 ], [ 630996.60468876315, 6902548.423605497 ], [ 633996.60468876315, 6902548.423605497 ], [ 634000.0, 6902000.0 ], [ 635000.0, 6902000.0 ], [ 635006.79062247381, 6900816.6531932093 ], [ 638006.79062247381, 6900816.6531932093 ], [ 638000.0, 6900000.0 ], [ 639000.0, 6900000.0 ], [ 639000.0, 6899000.0 ], [ 645000.0, 6899000.0 ], [ 645000.0, 6898000.0 ], [ 646000.0, 6898000.0 ], [ 646000.0, 6897000.0 ], [ 647000.0, 6897000.0 ], [ 647000.0, 6899000.0 ], [ 648000.0, 6899000.0 ], [ 648000.0, 6900000.0 ], [ 652000.0, 6900000.0 ], [ 652000.0, 6898000.0 ], [ 653000.0, 6898000.0 ], [ 653000.0, 6897000.0 ], [ 667000.0, 6897000.0 ], [ 667000.0, 6893000.0 ], [ 669000.0, 6893000.0 ], [ 669000.0, 6890000.0 ], [ 672000.0, 6890000.0 ], [ 672000.0, 6891000.0 ], [ 675000.0, 6891000.0 ], [ 675000.0, 6890000.0 ], [ 677000.0, 6890000.0 ], [ 677000.0, 6889000.0 ], [ 678000.0, 6889000.0 ], [ 678000.0, 6888000.0 ], [ 681000.0, 6888000.0 ], [ 681000.0, 6887000.0 ], [ 682000.0, 6887000.0 ], [ 682000.0, 6888000.0 ], [ 683000.0, 6888000.0 ], [ 683000.0, 6889000.0 ], [ 684000.0, 6889000.0 ], [ 684000.0, 6890000.0 ], [ 688000.0, 6890000.0 ], [ 688000.0, 6889000.0 ], [ 689000.0, 6889000.0 ], [ 689000.0, 6892000.0 ], [ 714000.0, 6892000.0 ], [ 714000.0, 6885000.0 ], [ 715000.0, 6885000.0 ], [ 715000.0, 6881000.0 ], [ 714000.0, 6881000.0 ], [ 714000.0, 6880000.0 ], [ 716000.0, 6880000.0 ], [ 716000.0, 6879000.0 ], [ 717000.0, 6879000.0 ], [ 717000.0, 6878000.0 ], [ 718000.0, 6878000.0 ], [ 718000.0, 6876592.5626515765 ], [ 720000.0, 6876592.5626515765 ], [ 720000.0, 6875000.0 ], [ 721000.0, 6875000.0 ], [ 721000.0, 6874000.0 ], [ 724000.0, 6874000.0 ], [ 724000.0, 6872000.0 ], [ 725000.0, 6872000.0 ], [ 725000.0, 6871000.0 ], [ 729000.0, 6871000.0 ], [ 729000.0, 6869000.0 ], [ 730000.0, 6869000.0 ], [ 730000.0, 6866000.0 ], [ 731000.0, 6866000.0 ], [ 731000.0, 6865000.0 ], [ 732629.91107518191, 6864989.814066289 ], [ 732633.30638641876, 6863986.4187550526 ], [ 735000.0, 6864000.0 ], [ 735013.58124494751, 6862687.6313662082 ], [ 738013.58124494751, 6862687.6313662082 ], [ 738000.0, 6856000.0 ], [ 737000.0, 6856000.0 ], [ 737013.58124494739, 6855298.7873888444 ], [ 734013.58124494739, 6855298.7873888444 ], [ 734013.58124494739, 6850443.1689571543 ], [ 736013.58124494739, 6850443.1689571543 ], [ 736000.0, 6846000.0 ], [ 737000.0, 6846000.0 ], [ 737000.0, 6842000.0 ], [ 736000.0, 6842000.0 ], [ 736000.0, 6841000.0 ], [ 736570.73565076792, 6840993.2093775263 ], [ 736575.98502506025, 6839999.5412917417 ], [ 741000.0, 6840000.0 ], [ 741000.0, 6839000.0 ], [ 742000.0, 6839000.0 ], [ 742000.0, 6837000.0 ], [ 743000.0, 6837000.0 ], [ 743000.0, 6834000.0 ], [ 742000.0, 6834000.0 ], [ 742000.0, 6833000.0 ], [ 740000.0, 6833000.0 ], [ 740000.0, 6831000.0 ], [ 738877.76879547292, 6831000.0 ], [ 738877.76879547292, 6830000.0 ], [ 737000.0, 6830000.0 ], [ 737000.0, 6829000.0 ], [ 738000.0, 6829000.0 ], [ 738000.0, 6826000.0 ], [ 737000.0, 6826000.0 ], [ 737000.0, 6825000.0 ], [ 736000.0, 6825000.0 ], [ 736000.0, 6824000.0 ], [ 734000.0, 6824000.0 ], [ 734000.0, 6819000.0 ], [ 732000.0, 6819000.0 ], [ 732000.0, 6814000.0 ], [ 733000.0, 6814000.0 ], [ 733000.0, 6809000.0 ], [ 732000.0, 6809000.0 ], [ 732003.39531123685, 6808407.4373484235 ], [ 729000.0, 6808404.0420371871 ], [ 729000.0, 6807000.0 ], [ 728000.0, 6807000.0 ], [ 728000.0, 6806000.0 ], [ 720000.0, 6806000.0 ], [ 720000.0, 6805000.0 ], [ 713000.0, 6805000.0 ], [ 713000.0, 6806000.0 ], [ 710000.0, 6806000.0 ], [ 710000.0, 6805000.0 ], [ 709000.0, 6805000.0 ], [ 709000.0, 6804000.0 ], [ 705000.0, 6804000.0 ], [ 705000.0, 6802000.0 ], [ 704000.0, 6802000.0 ], [ 704000.0, 6799000.0 ], [ 705000.0, 6799000.0 ], [ 705000.0, 6798000.0 ], [ 706000.0, 6798000.0 ], [ 706000.0, 6794000.0 ], [ 705000.0, 6794000.0 ], [ 705000.0, 6793000.0 ], [ 704000.0, 6793000.0 ], [ 704000.0, 6792000.0 ], [ 703000.0, 6792000.0 ], [ 703000.0, 6790000.0 ], [ 702000.0, 6790000.0 ], [ 702000.0, 6788000.0 ], [ 700000.0, 6788000.0 ], [ 700000.0, 6787000.0 ], [ 699000.0, 6787000.0 ], [ 699000.0, 6786000.0 ], [ 697000.0, 6786000.0 ], [ 697000.0, 6783000.0 ], [ 694000.0, 6783000.0 ], [ 693998.30234438158, 6782441.390460792 ], [ 691013.58124494739, 6782441.390460792 ], [ 691000.0, 6781000.0 ], [ 689716.49151172186, 6781003.3953112364 ], [ 689714.79385610344, 6780006.7906224737 ], [ 688000.0, 6780000.0 ], [ 688000.0, 6779000.0 ], [ 684000.0, 6779000.0 ], [ 684000.0, 6780000.0 ], [ 683000.0, 6780000.0 ], [ 683000.0, 6781000.0 ], [ 682000.0, 6781000.0 ], [ 682000.0, 6780000.0 ], [ 680000.0, 6780000.0 ], [ 680000.0, 6779000.0 ], [ 677741.95634599833, 6779000.0 ], [ 677741.95634599833, 6778000.0 ], [ 674000.0, 6778000.0 ], [ 674000.0, 6779000.0 ], [ 673000.0, 6779000.0 ], [ 673000.0, 6780000.0 ], [ 672000.0, 6780000.0 ], [ 672000.0, 6779000.0 ], [ 667000.0, 6779000.0 ], [ 667000.0, 6780000.0 ], [ 666000.0, 6780000.0 ], [ 666000.0, 6779000.0 ], [ 657000.0, 6779000.0 ], [ 657000.0, 6782972.8375101043 ], [ 658000.0, 6782972.8375101043 ], [ 657998.30234438169, 6784658.7712206952 ], [ 659000.00000000012, 6784660.4688763134 ], [ 659000.0, 6786000.0 ], [ 660000.0, 6786000.0 ], [ 660000.0, 6786443.1689571543 ], [ 661000.0, 6786443.1689571543 ], [ 661000.0, 6788000.0 ], [ 662000.0, 6788000.0 ], [ 662000.0, 6792000.0 ], [ 660000.0, 6792000.0 ], [ 660000.0, 6793000.0 ], [ 650000.0, 6793000.0 ], [ 650000.0, 6800000.0 ], [ 646000.0, 6800000.0 ], [ 646000.0, 6799000.0 ], [ 645000.0, 6799000.0 ], [ 645000.0, 6798000.0 ], [ 643000.0, 6798000.0 ], [ 643000.0, 6799000.0 ], [ 642000.0, 6799000.0 ], [ 642000.0, 6801000.0 ], [ 641000.0, 6801000.0 ], [ 641000.0, 6800000.0 ], [ 640000.0, 6800000.0 ], [ 640000.0, 6799000.0 ], [ 638000.0, 6799000.0 ], [ 638000.0, 6798000.0 ], [ 637000.0, 6798000.0 ], [ 637000.0, 6799000.0 ], [ 635000.0, 6799000.0 ], [ 635000.0, 6798000.0 ], [ 631000.0, 6798000.0 ], [ 631000.0, 6797000.0 ], [ 623000.0, 6797000.0 ], [ 623000.0, 6798000.0 ], [ 622000.0, 6798000.0 ], [ 622000.0, 6799000.0 ], [ 621000.0, 6799000.0 ], [ 621001.69765561842, 6803743.6540016169 ], [ 622001.69765561842, 6803743.6540016169 ], [ 622003.39531123685, 6810149.3936944222 ], [ 620003.39531123685, 6810149.3936944222 ], [ 620000.0, 6811000.0 ], [ 619000.0, 6811000.0 ], [ 619000.0, 6814000.0 ], [ 614000.0, 6814000.0 ], [ 614000.0, 6815329.3451899756 ], [ 613000.0, 6815329.3451899756 ], [ 613000.0, 6817033.9531123694 ], [ 611000.0, 6817033.9531123694 ], [ 611000.0, 6818000.0 ], [ 610000.0, 6818000.0 ], [ 610000.0, 6820000.0 ], [ 609000.0, 6820000.0 ], [ 609000.0, 6823000.0 ], [ 608000.0, 6823000.0 ], [ 608000.0, 6828000.0 ], [ 607000.0, 6828000.0 ], [ 607000.0, 6829176.5561843161 ], [ 605000.0, 6829176.5561843161 ], [ 605000.0, 6830000.0 ], [ 603000.0, 6830000.0 ], [ 603020.3718674212, 6834387.0654810024 ], [ 600000.0, 6834387.0654810024 ], [ 600000.0, 6835000.0 ], [ 599000.0, 6835000.0 ], [ 599000.0, 6838000.0 ], [ 598000.00000000012, 6838000.0 ], [ 598000.00000000012, 6839000.0 ], [ 596000.0, 6839000.0 ], [ 596000.0, 6840000.0 ], [ 595000.0, 6840000.0 ], [ 595000.0, 6844000.0 ], [ 594000.0, 6844000.0 ], [ 594000.0, 6848000.0 ], [ 595000.0, 6848000.0 ], [ 595000.0, 6851000.0 ], [ 594000.0, 6851000.0 ], [ 594000.0, 6862112.0452708164 ], [ 593000.0, 6862112.0452708164 ], [ 593000.0, 6863000.0 ], [ 592000.0, 6863000.0 ], [ 592000.0, 6864000.0 ], [ 591000.0, 6864000.0 ], [ 591000.0, 6865996.6046887627 ], [ 592000.0, 6865993.2093775263 ], [ 592000.0, 6867000.0 ], [ 591101.85933710588, 6866993.2093775263 ], [ 591098.46402586903, 6869067.9062247379 ], [ 589006.79062247381, 6869071.3015359743 ], [ 589000.0, 6871000.0 ], [ 588000.0, 6871000.0 ], [ 588000.0, 6875000.0 ], [ 586103.55699272442, 6875000.0 ], [ 586103.84284429357, 6875971.7869238332 ], [ 586000.35756107711, 6875971.3612318663 ], [ 586003.54355935147, 6880016.8289156994 ], [ 587002.32351311669, 6880022.7633628687 ], [ 587002.63550864242, 6881000.5956181437 ], [ 586592.48181083263, 6880998.5448666131 ], [ 585860.79223928868, 6884978.0113177039 ], [ 586000.0, 6885220.8569118837 ], [ 587759.98383185128, 6887000.0 ], [ 590000.0, 6887000.0 ], [ 590000.0, 6889000.0 ] ] ]
).transform("EPSG:2154", "EPSG:3857");

var smpLatest = makeOlTileLayerForSMP({
  extent: extentSMPLatest,
  projection: L93,
  resolutions: resSMPLatest,
  layerKey: 'IDF2015-2016',
  attributions: 'IDF 2015-2016 \u00A9 AtlsCity 2018',
  clippingGeom: clipSmpLatest
});


/**
 * Definition of WW II 1942 Royal Air Force Imagery SMP layer
 ******************************************************************/

var resSMP1942= [512.0, 256.0, 128.0, 64.0, 32.0, 16.0, 8.0, 4.0, 2.0, 1.0];
var extentSMP1942 = [582000.0, 107000.0, 627056.0, 144120.00];
var clipSmp1942 = new ol.geom.MultiPolygon(
	[ [ [ [ 582000.0, 107000.00 ], [ 582000.00, 144120.00 ], [ 627056.00, 144120.00 ], [ 627056.00, 107000.00 ], [ 582000.00, 107000.00 ] ] ] ]
).transform("EPSG:27561", "EPSG:3857");


var smpParis1942 = makeOlTileLayerForSMP({
  extent: extentSMP1942,
  projection: L1N,
  resolutions: resSMP1942,
  layerKey: 'Paris1942',
  attributions: 'Paris 1942 Royal Air Force \u00A9 AtlsCity 2018',
  clippingGeom: clipSmp1942
});


/**
 * Definition of an ol layer for SMP TMS
 * Mandatory:
 *  - array of resolution levels, 
 *  - extent
 *  - clipping geometry
 *  - key to build URL
 * Optionals:
 *  - Layer attributions
 *  - clipping geometry  
 * TODO make an ol.layer.SMP class for an easiest integration
 */

function makeOlTileLayerForSMP(opt_options) {
  var options = opt_options || {};

  var smpExtent = options.extent !== undefined ? options.extent : null;
  var smpProj = options.projection !== undefined ? options.projection : null;
  var smpResolutions = options.resolutions !== undefined ? options.resolutions : null;
  var smpKey = options.layerKey !== undefined ? options.layerKey : null;
  var smpAttributions = options.attributions !== undefined ? options.attributions : '\u00A9 AtlasCity 2018'
  var smpClipGeom = options.clippingGeom !== undefined ? options.clippingGeom : null;

  if (smpExtent == null || smpProj == null || smpResolutions == null || smpKey == null) {
    console.log("Need an extent, a projection, an array of resoultions and a layer key to define a SMP layer. Please check your parameters !!!");
    return null;
  }  

  if (smpClipGeom == null) {
    console.log ("Warning, no clipping geometry where given, clipping will be disabled for this layer")
  }

  var smpLayer =new ol.layer.Tile({
    attributions: smpAttributions,
    visible: false,
    opacity: 1.0,
    preload: 0,
    source: new ol.source.TileImage({
    crossOrigin: null,
    extent: smpExtent,
    projection: smpProj,
    tileGrid: new ol.tilegrid.TileGrid({
		    extent: smpExtent,
		    origin: [smpExtent[0], smpExtent[1]],
		    resolutions: smpResolutions
		    }),
            tileUrlFunction: function(coordinate) {
		    //window.alert("coordinate: "+coordinate);
		    if (coordinate == null) return undefined;
		    // TMS Style URL
		    var z = coordinate[0];
		    var x = coordinate[1];
		    var y = coordinate[2];
			  var randPort = Math.floor(Math.random() * (8049 - 8000 + 1)) + 8000
		    var url = 'http://'+smpTmsSvcHost+':'+randPort+'/tms/1.1.0/'+smpKey+'/'+z+'/'+ x +'/'+y +'.jpg';
		    return url;
		    }
	    })
  });

  if (smpClipGeom != null) {
    /**
     * 'precompose' et 'postcompose' callback for latest layer.
     * Use 'smpClipStyle' et 'clipSmpLatest'
     */
    smpLayer.on('precompose', function(event) {
      var vecCtx = event.vectorContext;
      var ctx = event.context;
      ctx.save();

      vecCtx.setStyle(smpClipStyle);
      vecCtx.drawGeometry(smpClipGeom);
      ctx.clip();
    });

    smpLayer.on('postcompose', function(event) {
      var ctx = event.context;
      ctx.restore();
    });
  }

return smpLayer;
};


